version: '3.8'

services:
  caddy:
    image: caddy:latest
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - qgis-server-net
    depends_on:
      - qgis-server

  qgis-server:
    image: "qgis/qgis-server:stable"
    environment:
      # Do not run the embedded copy of nginx
      SKIP_NGINX: "true"
      # Configure QGIS Server
      QGIS_PLUGINPATH: "/io/plugins"
      QGIS_SERVER_PARALLEL_RENDERING: "true"
      QGIS_SERVER_MAX_THREADS: "4"
      QGIS_SERVER_WMS_MAX_HEIGHT: "5000"
      QGIS_SERVER_WMS_MAX_WIDTH: "5000"
      QGIS_SERVER_LOG_LEVEL: "0"  # Most verbose for debugging
      QGIS_SERVER_LOG_STDERR: "true"
      # Plugin-specific environment variables
      QGIS_SERVER_PLUGIN_ProjectInfo: "1"
    networks:
      - qgis-server-net
    volumes:
      # Mount project data
      - ./projects:/io/data:ro
      # Mount plugins directory
      - ./plugins:/io/plugins
      # Optional: Mount custom fonts and SVG symbols if needed
      # - ./fonts:/usr/share/fonts
      # - ./svg:/var/lib/qgis/.local/share/QGIS/QGIS3/profiles/default/svg
    restart: unless-stopped
    command: >
      sh -c "mkdir -p /var/log/qgis &&
             spawn-fcgi -p 9993 -n -d /tmp 
             /usr/lib/cgi-bin/qgis_mapserv.fcgi"

networks:
  qgis-server-net:
    driver: bridge

volumes:
  caddy_data:
  caddy_config: